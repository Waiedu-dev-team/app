#!/bin/bash

echo "ðŸš€ WAIEDU Complete Development Environment Setup"
echo "=============================================="
echo "âœ¨ One-command setup: Firewall + Backend + Frontend + Sharing"
echo ""

# Function to get local IP
get_local_ip() {
    local_ip=$(hostname -I | awk '{print $1}' 2>/dev/null)
    if [ -z "$local_ip" ]; then
        local_ip=$(ip route get 1.1.1.1 | grep -oP 'src \K\S+' 2>/dev/null)
    fi
    if [ -z "$local_ip" ]; then
        local_ip=$(ifconfig | grep -Eo 'inet (addr:)?([0-9]*\.){3}[0-9]*' | grep -Eo '([0-9]*\.){3}[0-9]*' | grep -v '127.0.0.1' | head -1)
    fi
    echo "$local_ip"
}

# Function to get public IP
get_public_ip() {
    public_ip=$(curl -s --max-time 5 ifconfig.me 2>/dev/null)
    if [ -z "$public_ip" ]; then
        public_ip=$(curl -s --max-time 5 ipinfo.io/ip 2>/dev/null)
    fi
    echo "$public_ip"
}

# Function to setup firewall
setup_firewall() {
    echo "ðŸ”’ Setting up firewall..."
    
    # Check if ufw is installed
    if ! command -v ufw &> /dev/null; then
        echo "ðŸ“¦ Installing UFW firewall..."
        sudo apt update && sudo apt install -y ufw
    fi

    # Enable UFW and open necessary ports
    echo "ðŸŒ Configuring firewall rules..."
    sudo ufw --force enable > /dev/null 2>&1
    sudo ufw allow 3000/tcp > /dev/null 2>&1  # Backend API
    sudo ufw allow 3001/tcp > /dev/null 2>&1  # Staff Frontend
    sudo ufw allow 3002/tcp > /dev/null 2>&1  # Client Frontend
    sudo ufw allow 80/tcp > /dev/null 2>&1    # HTTP
    sudo ufw allow 443/tcp > /dev/null 2>&1   # HTTPS
    sudo ufw allow 22/tcp > /dev/null 2>&1    # SSH
    
    echo "âœ… Firewall configured successfully!"
}

# Function to check if ports are available
check_port() {
    local port=$1
    local service=$2
    if lsof -i :$port > /dev/null 2>&1; then
        echo "âš ï¸  Port $port Ä‘Ã£ bá»‹ chiáº¿m bá»Ÿi service khÃ¡c!"
        echo "   Stopping existing service trÃªn port $port..."
        # Try to stop existing service
        sudo fuser -k $port/tcp > /dev/null 2>&1
        sleep 2
        if lsof -i :$port > /dev/null 2>&1; then
            echo "âŒ KhÃ´ng thá»ƒ giáº£i phÃ³ng port $port. Vui lÃ²ng stop service thá»§ cÃ´ng."
            return 1
        fi
    fi
    return 0
}

# Function to create environment file
create_env_file() {
    echo "ðŸ“ Creating environment configuration..."
    
    cat > waiedu_backend/.env << EOF
# WAIEDU Backend Environment Variables
# Auto-generated by start-dev.sh

# Server Configuration (0.0.0.0 for public sharing)
PORT=3000
HOST=0.0.0.0
NODE_ENV=development

# JWT Configuration
JWT_SECRET=waiedu-secret-key-dev-$(date +%s)

# CORS Configuration (allow all for development)
CORS_ORIGIN=*

# Database Configuration (for future use)
# DB_HOST=localhost
# DB_PORT=5432
# DB_USERNAME=waiedu_user
# DB_PASSWORD=waiedu_password
# DB_DATABASE=waiedu
EOF
    
    echo "âœ… Environment file created with 0.0.0.0 configuration!"
}

echo "ðŸ”§ STEP 1: System Preparation"
echo "============================="

# Setup firewall
setup_firewall

# Check ports availability
echo ""
echo "ðŸ” Checking port availability..."
check_port 3000 "Backend" || exit 1
check_port 3001 "Frontend Staff" || exit 1
check_port 3002 "Client Staff" || exit 1
echo "âœ… All ports are available!"

# Create environment configuration
echo ""
create_env_file

echo ""
echo "ðŸ³ STEP 2: Backend Setup (Docker)"
echo "================================="

# Ensure we're in the right directory
cd waiedu_backend

# Build and start backend
echo "ðŸ“¦ Building Docker image..."
sudo docker-compose build

if [ $? -eq 0 ]; then
    echo "âœ… Docker build successful!"
    echo "ðŸš€ Starting backend container..."
    sudo docker-compose up -d
    
    if [ $? -eq 0 ]; then
        echo "âœ… Backend container started successfully!"
    else
        echo "âŒ Failed to start backend container"
        exit 1
    fi
else
    echo "âŒ Docker build failed"
    exit 1
fi

cd ..

echo ""
echo "âš›ï¸  STEP 3: Frontend Setup (Next.js)"
echo "===================================="

# Create logs directory
mkdir -p logs

# Start Staff Frontend (waiedu_staff)
echo "ðŸš€ Starting staff frontend development server..."
cd waiedu_staff

# Check if node_modules exists, if not install dependencies
if [ ! -d "node_modules" ]; then
    echo "ðŸ“¦ Installing staff frontend dependencies..."
    npm install
fi

# Start staff frontend in background
PORT=3001 npm run dev > ../logs/frontend-staff.log 2>&1 &
FRONTEND_STAFF_PID=$!
echo $FRONTEND_STAFF_PID > ../logs/frontend-staff.pid

cd ..

echo "âœ… Staff frontend server starting on port 3001..."

# Start Client Frontend (client_staff)  
echo "ðŸš€ Starting client frontend development server..."
cd client_staff

# Check if node_modules exists, if not install dependencies
if [ ! -d "node_modules" ]; then
    echo "ðŸ“¦ Installing client frontend dependencies..."
    npm install
fi

# Start client frontend in background
PORT=3002 npm run dev > ../logs/frontend-client.log 2>&1 &
FRONTEND_CLIENT_PID=$!
echo $FRONTEND_CLIENT_PID > ../logs/frontend-client.pid

cd ..

echo "âœ… Client frontend server starting on port 3002..."

echo ""
echo "â³ Waiting for services to fully start..."
sleep 8

echo ""
echo "ðŸŒ STEP 4: Server Information & Sharing"
echo "======================================="

# Get IP addresses
LOCAL_IP=$(get_local_ip)
PUBLIC_IP=$(get_public_ip)

echo "ðŸ“ Server Access Information:"
echo "============================"

echo "ðŸ  Local Access:"
echo "   Backend:      http://localhost:3000"
echo "   Staff App:    http://localhost:3001"
echo "   Client App:   http://localhost:3002"
echo "   Swagger API:  http://localhost:3000/api-docs"

if [ -n "$LOCAL_IP" ]; then
    echo ""
    echo "ðŸŒ Network Access (Same WiFi/LAN):"
    echo "   Backend:      http://$LOCAL_IP:3000"
    echo "   Staff App:    http://$LOCAL_IP:3001"
    echo "   Client App:   http://$LOCAL_IP:3002"
    echo "   Swagger API:  http://$LOCAL_IP:3000/api-docs"
fi

if [ -n "$PUBLIC_IP" ]; then
    echo ""
    echo "ðŸŒ Public Access (with port forwarding):"
    echo "   Backend:      http://$PUBLIC_IP:3000"
    echo "   Staff App:    http://$PUBLIC_IP:3001"
    echo "   Client App:   http://$PUBLIC_IP:3002"
    echo "   (Configure router: 3000,3001,3002 â†’ $LOCAL_IP:3000,3001,3002)"
fi

echo ""
echo "ðŸ“‹ Quick Share URLs:"
echo "==================="
if [ -n "$LOCAL_IP" ]; then
    echo "ðŸ“± LAN Sharing:"
    echo "   API Server:   http://$LOCAL_IP:3000"
    echo "   Staff App:    http://$LOCAL_IP:3001"
    echo "   Client App:   http://$LOCAL_IP:3002"
fi

echo ""
echo "ðŸ”— Alternative: Use ngrok for instant public sharing:"
echo "   ngrok http 3000  # For backend API"
echo "   ngrok http 3001  # For frontend app"

echo ""
echo "ðŸ”§ Management Commands:"
echo "======================"
echo "   View backend logs:       sudo docker-compose -f waiedu_backend/docker-compose.yml logs -f"
echo "   View staff frontend:     tail -f logs/frontend-staff.log"
echo "   View client frontend:    tail -f logs/frontend-client.log"
echo "   Stop all services:       ./stop-dev.sh"
echo "   Restart backend:         cd waiedu_backend && sudo docker-compose restart"

echo ""
echo "ðŸ”’ Security Notes:"
echo "=================="
echo "   âœ… Firewall ports opened (3000, 3001, 3002, 80, 443, 22)"
echo "   âœ… Server configured for 0.0.0.0 (public access)"
echo "   âœ… CORS enabled for all origins"
echo "   âš ï¸  For production: Change JWT_SECRET in .env"
echo "   âš ï¸  For internet access: Configure router port forwarding"

echo ""
echo "ðŸŽ‰ WAIEDU Development Environment Ready!"
echo "========================================"
echo "âœ¨ Backend API: Ready for connections from any IP"
echo "âœ¨ Staff App: Running with development features (Port 3001)" 
echo "âœ¨ Client App: Running with development features (Port 3002)"
echo "âœ¨ Sharing: Configured for both local and public access"
echo ""
echo "ðŸš€ Happy coding! Use ./stop-dev.sh to stop all services."

echo ""
echo "ðŸ”„ Live Logs Preview (Ctrl+C to exit, services continue running):"
echo "================================================================="
sleep 3

# Show combined logs
if [ -f "logs/frontend-staff.log" ]; then
    echo "ðŸ“‹ Staff Frontend Logs:"
    tail -f logs/frontend-staff.log &
    TAIL_STAFF_PID=$!
fi

if [ -f "logs/frontend-client.log" ]; then
    echo "ðŸ“‹ Client Frontend Logs:"
    tail -f logs/frontend-client.log &
    TAIL_CLIENT_PID=$!
fi

echo "Press Ctrl+C to exit log view (services will continue running)"
echo "Use './stop-dev.sh' to stop all services"

# Wait for user to press Ctrl+C
trap 'echo ""; echo "ðŸ‘‹ Log view stopped. Services are still running!"; echo "Use ./stop-dev.sh to stop all services"; kill $TAIL_STAFF_PID 2>/dev/null; kill $TAIL_CLIENT_PID 2>/dev/null; exit 0' INT

# Keep showing logs until user interrupts
while true; do
    sleep 1
done
